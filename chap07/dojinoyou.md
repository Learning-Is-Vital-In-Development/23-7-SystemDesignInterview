# 7. 분산시스템을 위한 유일 ID 생성기 설계

## 설계 범위 확정

- 유일해야 한다.
- 숫자로만 구성되어야 한다.
- 64비트로 표현될 수 있는 값이어야 한다.
- 발급 날짜에 따라 정렬 가능해야 한다.
- 초당 1만개의 ID를 만들 수 있어야 한다.

## 개략적인 설계안

분산 시스템에서 유일성이 보장되는 ID를 만드는 방법은 다음과 같은 선택지가 있을 수 있다.

- 다중 마스터 복제(multi-master replication)
- UUID(Universally Unique Identifier)
- 티켓 서버(ticker server)
- 트위터 스노플레이크(twitter snowflake) 접근법

### 다중 마스터 복제

데이터 베이스의 auto_increment 기능을 활용하는 것이다. 다만, 1씩 증가시키는 것이 아니라 k만큼 증가시킨다. 이때 k는 현재 사용중인 데이터베이스 서버의 수이다.

단점

- 여러 데이터 센터에 걸쳐 규모를 늘리기 어렵다.
- ID의 유일성은 보장되겠지만, 그 값이 시간 흐름에 맞추어 커지도록 보장할 수 없다.
- 서버를 추가하거나 삭제할 때도 잘 동작하도록 만들기 어렵다.

### UUID

장점

- UUID를 만드는 것은 단순하다. 동기화 이슈도 없다.
- 각 서버가 자기가 쓸 ID를 알아서 만드는 구조이므로 규모 확장도 쉽다.

단점

- ID가 128비트로 길다.
- ID를 시간순으로 정렬할 수 없다.
- ID에 숫자(numeric) 아닌 값이 포함될 수 있다.

### 티켓서버

auto_increment 기능을 갖춘 데이터베이스 서버, 즉 티켓 서버를 중앙 집중형으로 하나만 사용하는 것

**장점**

- 유일성이 보장되는 오직 숫자로 구성된 ID를 쉽게 만들 수 있다.
- 구현하기 쉽고, 중소 규모 애플리케이션에 적합하다.

**단점**

- 티켓 서버가 SPOF가 된다. 이 서버에 장애가 발생하면 해당 서버를 이용하는 모든 시스템이 영향을 받는 다.
- 이 이슈를 피하려면 티켓 서버를 여러 대 준비 해야 한다. 이러면 데이터 동기화 같은 이슈가 발생한다.

### 트위터 스노플레이크 접근법

![image](https://user-images.githubusercontent.com/61923768/235458407-876fef02-7d6a-4034-b842-abd2d7098519.png)

생성해야 하는 ID의 구조를 여러 절(section)로 분할하는 것이다.

- sign 비트: 나중을 위해 유보해준다.
- timestamp 비트: 41비트를 할당한다. epoch 이후로 몇 밀리초가 경과했는 지 나타내는 값이다.
- 데이터 센터 ID: 5비트를 할당해 32개의 센터를 지원할 수 있다.
- 서버 ID: 5비트를 할당해 32개의 서버를 지원할 수 있다.
- 일련번호: 12비트를 할당해 각 서버에서 id를 생성할 때마다 1씩 증가시키며 1밀리초가 지나면 0으로 초기화한다.

## 상세 설계

데이터 센터 ID와 서버 ID는 시스템이 시작할 때 결정되며, 일반적으로 시스템 운영 중에는 바뀌지 않는 다. 잘못 변경할 경우 ID 충돌이 발생할 수 있으므로, 그런 작업을 할 때는 신중해야 한다.

### 타임 스탬프

41비트로 표현할 수 있는 타임스탬프의 최대값은 $2^{41}$ 밀리초로 대략 69년에 해당한다.

### 일련 번호

일련 번호는 12비트이므로 4096개 값을 가질 수 있고 같은 밀리초동안 하나 이상 ID를 만들어 낸 경우메나 0보다 큰 값을 가진다.

## 마무리

추가적으로 논의할 수 있는 내용은 다음과 같다.

- 시계 동기화(clock synchronization): 전부 같은 시계를 사용한다고 가정하였다. 하지만 하나의 서버가 여러 코어에서 실행될 경우 유효하지 않을 수 있다. 여러 서버가 물리적으로 여러 장비에서 실행되는 경우에도 동일하다. 이런 문제 해결엔 NTP(Network Time Protocol)을 참고하면 된다.
- 각 절(Section)의 길이 최적화: 동시성(concurrency)이 낮고 수명이 긴 애플리케이션이라면 일련 번호 절의 길이를 줄이고 타임 스탬프 절의 길이를 늘리는 것이 효과적일 수도 있을 것이다.
- 고가용성(high availability): ID 생성기는 필수 불가결(mission cirtical) 컴포넌트이므로 아주 높은 가용성을 제공해야 할 것이다.
