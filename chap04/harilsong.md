# 4장. 처리율 제한 장치(rate limiter)

처리율 제한 장치는 네트워크 시스템에서 클라이언트 또는 서비스가 보내는 트래픽의 처리율(rate)을 제한하기 위한 장치다.

HTTP 를 예로 들면 이 장치는 특정 기간 내에 전송되는 클라이언트의 요청 횟수를 제한한다. API 요청 횟수가 제한 장치에 정의된
임계치를 넘어서면 추가로 도달한 모든 호출은 중단된다.

## 문제 이해 및 설계

### 1단계: 문제 이해 및 설계 범위 확정

처리율 제한 장치는 여러가지 알고리즘을 사용해서 구현할 수 있고 각각 고유한 장단점을 갖기 때문에, 어떤 알고리즘을 사용할지
면접관과 소통하며 결정을 내려야 한다.

### 2단계: 개략적 설계안 제시 및 동의 구하기

#### 처리율 제한 장치의 위치

처리율 제한 장치는 클라이언트와 서비스 사이에 위치할 수도 있고, 서비스 내부에 위치할 수도 있다. 클라이언트와 서비스 사이에
위치하는 경우에는 클라이언트가 서비스에 요청을 보내기 전에 처리율 제한 장치에 요청을 보내고, 서비스 내부에 위치하는 경우에는
클라이언트가 서비스에 요청을 보낸 후에 처리율 제한 장치에 요청을 보낸다.

#### 처리율 제한 장치의 구현 방법

처리율 제한 장치는 다음과 같은 방법으로 구현할 수 있다.

- 토큰 버킷 알고리즘
- 누출 버킷 알고리즘
- 고정 윈도 카운터 알고리즘
- 이동 윈도 로깅 알고리즘
- 이동 윈도 카운터 알고리즘

#### 토큰 버킷 알고리즘

- 간단하다.
- 알고리즘에 대한 세간의 이해도가 높다.
- 인터넷 기업들이 보편적으로 사용하고 있다.

#### 누출버킷 알고리즘

누출버킷 알고리즘은 FIFO 큐로 구현한다.

- 큐의 크기가 제한되어 있어 메모리 사용량 측면에서 효율적이다.
- 고정적인 출력을 갖고 있기 때문에 안정적 출력이 필요한 경우 적합하다.

#### 고정 윈도 카운터 알고리즘

- 메모리 효율이 좋다.
- 윈도가 닫히는 시점에 카운터를 초기화하는 방식은 특정한 트래픽 패턴을 처리하기에 적합하다.
- 윈도의 경계 부근에 트래픽이 집중된 경우, 윈도에 할당된 양보다 많은 트래픽이 처리될 수 있다.

#### 이동 윈도 로깅 알고리즘

이동 윈도 로깅 알고리즘은 고정 윈도 카운터 알고리즘의 문제를 해결한다.

- 아주 정교한 매커니즘. 어느 순간의 윈도를 보더라도 허용되는 요청의 개수는 시스템의 처리율 한도를 넘지 않는다.
- 다량의 메모리를 사용한다. 거부된 요청의 타임스탬프도 보관하기 때문이다.

#### 이동 윈도 카운터 알고리즘

고정 윈도 카운터의 경계 문제와 이동 윈도 로깅의 로그 보관 비 등의 문제를 보완할 수 있는 알고리즘

- 이전 시간대의 평균 처리율에 따라 현재 윈도의 상태를 계산하므로 짧은 시간에 몰리는 트래픽에도 잘 대응한다.
- 메모리 효율이 좋다.
- 직전 타임슬롯에 도착한 요청이 균등하게 분포되어 있다고 가정하기 때문에 다소 느슨하다.

### 개략적인 아키텍처

알고리즘은 단순하다. 카운터를 어떤 정책으로 다룰지에 대한 이야기이다.

그렇다면 카운터를 어디에 보관해야할지를 정해야하는데, 주로 캐시 메모리가 사용된다.
