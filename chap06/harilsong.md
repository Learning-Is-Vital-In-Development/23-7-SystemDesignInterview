# 06장. 키-값 저장소 설계

키-값 저장소는 키-값 데이터베이스라고도 불리는 비관계형 데이터베이스이다. 이 저장소에 사용되는 값은 고유 식별자(Identifier)
를 키로 가지는데, 키와 값 사이의 이런 연결 관계를 Key-Value Pair 라고 지칭한다.

key-value pair 에서 키는 유일해야 한다. 키는 일반 텍스트일 수도 있고 해시 값일수도 있는데, 성능상의 이유로 키는 짧을수록 좋다.

## 단일 서버 키-값 저장소

키-값 쌍 전부를 메모리에 해시테이블로 저장

- 빠른 속도를 보장하긴 하지만 모든 데이터를 메모리 안에 두는 것이 불가능할 수도 있다

개선책:

- 데이터 압축
- 자주 쓰이는 데이터만 메모리에 두고 나머지는 디스크에 저장

그러나 이렇게 개선한다고 해도, 많은 데이터를 저장하려면 분산 키-값 저장소를 만들 필요가 있다.

## 분산 키-값 저장소

aka. 분산 해시 테이블

분산 시스템을 설계할 때는 CAP 정리를 이해하고 있어야 한다.

- 일관성(Consistency): 모든 클라이언트는 어떤 노드에 접속했느냐에 관계없이 언제나 같은 데이터를 보게 되어야 한다.
- 가용성(Availability): 일부 노드에 장애가 발생하더라도 항상 응답을 받을 수 있어야 한다.
- 분할 내성(Partition Tolerance): 네트워크 장애가 발생하더라도 시스템은 정상적으로 동작해야 한다.

CAP 정리는 분산 시스템을 설계할 때 어떤 것을 포기해야 할지를 결정하는 데 도움을 준다.

- CP: 일관성과 파티션 감내를 지원하는 키-값 저장소
- AP: 가용성과 파티션 감내를 지원하는 키-값 저장소
- CA: 일관성과 가용성을 지원하는 키-값 저장소. 그러나 네트워크 장애는 피할 수 없는 일로 여겨지므로, 실세계에 CA 시스템은 존재하지 않는다.

### 시스템 컴포넌트

- 데이터 파티션
- 데이터 다중화(Replication)
- 일관성(Consistency)
- 일관성 불일치 해소(Inconsistency Resolution)
- 장애 처리
- 시스템 아키텍처 다이어그램
- 쓰기 경로
- 읽기 경로

### 데이터 파티션

데이터를 작은 파티션들로 분할한 다음 여러 대 서버에 저장하는 것

- 데이터를 여러 서버에 고르게 분산할 수 있는가
- 노드가 추가되거나 삭제될 때 데이터의 이동을 최소화할 수 있는가

안정 해시는 이 문제를 푸는데 적합한 기술이다.

- 규모 확장 자동화(automatic scaling): 시스템 부하에 따라 서버가 자동으로 추가되거나 삭제되도록 만들 수 있다.
- 다양성(heterogeneity): 각 서버의 용량에 맞게 가상 노드의 수를 조절할 수 있다.

### 데이터 다중화

데이터를 여러 서버에 복제하는 것

해시 링 위에 배치한 후 시계 방향으로 링을 순회하면서 만나는 첫 N개 서버에 데이터 사본을 보관하는 방식으로 구현할 수 있다.

### 데이터 일관성

여러 노드에 다중화된 데이터는 적절히 동기화가 되어야 한다. 정족수 합의(Quorum Consensus)를 이용하면 이 문제를 해결할 수 있다.

#### 일관성 모델

- 강한 일관성(Strong Consistency): 모든 읽기 연산은 가장 최근에 갱신된 결과를 반환한다.
- 약한 일관성(Weak Consistency): 읽기 연산은 가장 최근에 갱신된 결과를 반환하지 못할 수 있다.
- 최종 일관성(Eventual Consistency): 약한 일관성의 한 형태로, 갱신 결과가 결국에는 모든 사본에 반영(즉, 동기화)되는 모델이다.

강한 일관성을 달성하는 일반적인 방법은, 모든 사본에 현재 쓰기 연산의 결과가 반영될 때까지 해당 데이터에 대한 읽기/쓰기를 금지하는 것이다.
이 방법은 새로운 요청의 처리가 중단되기 때문에 고가용성 시스템에는 적합하지 않다.

다이나모, 카산드라 같은 저장소는 최종 일관성 모델을 택하고 있는데, 최종 일관성 모델을 따를 경우 쓰기 연산이 병렬적으로 발생하면 데이터가 불일치 상태에 빠질 수 있다.
이 문제는 클라이언트가 해결해야 한다. 데이터의 버전 정보를 활용해 일관성이 깨진 데이터를 읽지 않도록 하는 기법에 대해서 살펴보자.

#### 비 일관성 해소 기법: 데이터 버저닝

데이터를 다중화하면 가용성은 높아지지만 사본 간 일관성이 깨질 가능성은 높아진다. 버저닝(Versioning)과 벡터 시계(Vector Clock)는 그 문제를 해소하기 위해 등장한 기술이다.

- 버저닝: 데이터를 변경할 때마다 해당 데이터의 새로운 버전을 만드는 기술. 따라서 각 버전의 데이터는 변경 불가능하다.
- 벡터 시계: 데이터의 버전을 관리하는 기술. 서버, 버전의 순서쌍을 데이터에 매단 것이다.

#### 장애 감지

- 가십 프로토콜: 노드 간에 서로 정보를 교환하면서 노드의 상태를 파악하는 프로토콜

