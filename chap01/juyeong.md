## 1장. 사용자 수에 따른 규모 확장성
규모 확장성을 고려한 시스템 설계시 고려할 부분

### 수직적인 확장(scale-up) vs 수평적인 확장(scale-out)
###수직적인 확장

단일서버에 고사양자원을 추가(CPU, RAM 추가)
사양을 무제한으로 증설 할 수 없음.
장애 발생 대비를 위한 자동복구/다중화 불가
단순함에서 오는 관리의 장점이 있음.
### 수평적인 확장
더 많은 서버를 증설하여 성능을 개선
### 로드밸런서P
여러 서버에 트래픽을 고루 분산
### 데이터베이스 다중화
성능, 안정성, 가용성을 얻을 수 있음.

성능
쓰기 연산만 수행하는 Master / 읽기 연산만 수행하는 여러대의 Slave 로 분할
쓰기와 읽기가 분할되어 성능에서 이득

안정성
자연 재해, 장비 고장으로 데이터베이스가 파괴되어도 다른 데이터 베이스가 존재하므로 데이터 보존가능
여러 지역에 데이터 베이스가 물리적으로 분산되어 있기 때문

가용성
특정 데이터베이스에 장애가 발생시, 다른 데이터베이스에 접근하여 계속 서비스 가능

캐시
별도의 캐시서버를 사용하여 데이터베이스 부하 경감 / 성능 개선을 얻음.
캐시 사용시 고려해야할 점이 많음.
어떤 상황에 유용한가?
- 데이터 갱신은 자주 일어나지 않으나 참조는 빈번하게 발생하는 경우.
어떤 데이터를 캐시에 두어야하는가?
- 캐시는 휘발성 메모리를 사용하므로 영속적으로 저장해야되는 데이터는 바람직 하지 않음
캐시 데이터의 만료 주기는?
- 만료기한이 너무 긴 경우 → 캐시에 데이터가 계속 남아 있어 원본과 차이가 발생
- 만료기한이 너무 짧은 경우 → 데이터 베이스를 자주 읽게 됨
데이터의 일관성 유지 방법
- 원본 데이터와 캐시데이터를 갱신하는 연산은 단일 트랜잭션으로 묶여야함 → 그렇지 않으면 일관성이 깨짐
장애에 대처하는 방법
- 캐시 서버가 한대인 경우 SPOF(Single Point of Failure, SOF)가 됨.
여러지역에 걸쳐 캐시 서버를 분산해야 SPOF문제를 피할 수 있음.
캐시 메모리 크기?
- 캐시메모리가 너무 작은 경우 데이터가 자주 방출되어 캐시 성능이 저하된다.
캐시 메모리를 과할당하
데이터 방출 정책?
- 캐시가 가득 찼을 때, 기존 데이터를 내보내는 정책. 경우에 맞게 사용
- LRU - Least Recently Used - 마지막으로 사용된 시점이 가장 오래된 데이터를 방출
- LFU - Least Frequently Used - 사용빈도가 가장 낮은 데이터를 내보내는 방출
- FIFO - First In First Out - 가장 먼저 캐시에 들어온 데이터를 가장 먼저 방출

## CDN
정적 콘텐츠를 캐시하여 전송하는데 사용(ex : 이미지, 비디오, CSS, js)

### 동작 과정

웹사이트 방문시 유저와 가장 가까운 CDN 서버 방문
CDN 서버는 정적 콘텐츠 전송
물리적인 거리를 줄일 수 있어 사이트 로딩 시간 단축 가능.

## 고려해야할 사항

### 비용
CDN은 보통 제 3사업자에 운영되며 데이터 송수신양에 따라 요금을 지불
자주 사용하지 않는 데이터를 캐싱하는것은 이득이 크지 않으므로 CDN에서 제외
### 적절한 만료 시한 설정
너무 짧아도, 길지도 않아야함.
너무 길면 컨텐츠의 신선도 감소
너무 짧으면 원본 서버에 자주 접근하게되어 효율 감소
###  장애에 대한 대처 방안
CDN에 장애 발생시 웹사이트, 어플리케이션이 어떻게 동작해야하는지 고려
CDN의 응답이 없다면 원본서버로부터 직접 컨텐츠를 가져오도록 구성하는것을 고려
### 컨텐츠 무효화
아직 만료기한이 도래하지 않은 컨텐츠라도 CDN에서 제거가능
CDN 사업자가 제공하는 API사용
오브젝트 버저닝 이용(ex : image.png?v=2)

## stateless 웹 계층
웹 계층을 수평적으로 확장하기위해서 상태 정보(ex:사용자 세션 데이터)를 웹 계층에서 제거

상태정보는 RDBMS, NOSQL 같은 지속성 저장소에 보관 및 필요시 가져오도록 구성

## 상태 의존적인 아키텍쳐

각각의 사용자가 각각의 서버에 저장되어 있는 구조

클라이언트는 항상 같은 서버로 전송되어야 함.(A사용자 → 1서버, B사용자 → 2서버)
만약 A사용자가 2서버에 연결되면 에러
이를 해결하기 위해 로드밸런서는 고정 세션(sticky session)기능을 제공
이런 구조는 로드 밸런서 뒷단에 서버 추가/수정이 어려움.
장애 처리 난이도 증가
무상태 아키텍쳐

사용자 ↔ 서버 ↔ 공유 저장소 구조

사용자는 어떤 웹 서버로도 전달 가능
상태 정보가 필요한 경우 웹 서버는 공유 저장소에서 데이터 로드
단순하며, 안정적이며, 규모확장이 쉬움

### 데이터센터
다중 데이터 아키텍쳐 구성시 기술적 난제 해결 필요

트래픽 우회
요청자와 지리적으로 가까운 데이터센터와 연결 필요(GeoDNS)사용
데이터 동기화
데이터센터마다 별도의 데이터를 사용하고 있는 상황 가정
장애 발생시 자동으로 복구, 데이터가 다른 데이터 센터로 우회되어도 원하는 데이턱 없는 경우가 발생
데이터를 여러 데이터 센터에 걸쳐 다중화.
테스트와 배포
웹사이트와 어플리케이션을 여러 위치에서 테스트 필요
자동화된 배포 도구를 활용하여 모든 데이터 센터에 동일한 서비스가 설치되도록 수행


### 메시지 큐
메시지의 무손실을 보장하는 비동기 통신 컴포넌트

생산자/발행자 (producer/publisher)가 메시지를 만들고 메시지 큐에 발행(publish)
메시지 큐에는 소비자/구독자(consumer/subscriber)가 서버에 연결되어 메시지를 받아 처리
메시지 큐 사용시 서비스 혹은 서버간 결합이 느슨해짐
따라서 규모확장성이 보장되어야하는 안정적인 어플리케이션 구성에 좋음
생산자는 소비자의 상태를 알 필요가 없고 소비자 또한 생산자의 상태를 알 필요가 없음.
시간이 오래 걸리는 프로세스는 비동기로 처리하면 편리함(ex:이미지 보정)

### 로그, 메트릭 및 자동화
웹 사이트와 함께 큰 규모의 사업에는 필수적으로 로그, 메트릭, 자동화에 투자할 것.

### 로그

에러 로그를 모니터링하는 것은 중요함
에러 로그는 서버 단위로 모니터링하거나, 로그를 단일 서비스로 모아주는 도구를 활용시 더욱 편리
### 메트릭
사업 현황이나 시스템의 현재 상태를 손쉽게 파악 할 수 있음.

호스트 단위 메트릭 : CPU, 메모리, 디스크 I/O에 관한 메트릭
종합(aggregated) 메트릭 : 데이터베이스, 캐시 성능
핵심 비즈니스 메트릭 : 일별 능동 사용자(Daily Active User), 수익(Revenue), 재방문(Retention)등이 이에 해당.

### 자동화

시스템이 크고 복잡해지면 생산성을 높히기 위해 자동화 도구 사용
지속적 통합(CI) 도구 활용시 개발자가 코드의 문제를 쉽게 감지 가능
CI를 사용하여 빌드, 테스트, 배포 절차 자동화 가능 및 개발 생산성 향상

## 데이터베이스의 규모 확장(수평, 수직)
데이터가 많아지면 데이터베이스에 대한 부하도 증가. 이때 두가지 방법으로 데이터 베이스를 증설

## 수직적 확장

수직적 규모 확장법 - 고성능의 자원(CPU, RAM, 디스크)를 증설, 쉬운 접근법이나 단점 존재

데이터베이스 서버 하드웨어에는 한계가 있으므로 CPU, RAM을 무한정 증설 할 수 없음.
SPOF(Single Point of Failure)로 인한 위험성이 큼
비용이 많이들며 고성능 서버로 갈 수록 가격이 올라가게 마련

수평적 확장
데이터베이스의 수평적 확장은 샤딩(sharding)이라고 표현.

- 샤딩은 대규모 데이터베이스를 샤드(shard)라고 부르는 작은 단위로 분할
- 모든 샤드는 같은 스키마를 사용하지만, 데이터는 중복되지 않음.

## 샤딩 전략
샤딩 전략을 구현시 고려해야할 점은 샤딩 키 지정 방식

샤딩키는 데이터를 고르게 분할 할 수 있도록 하는게 가장 중요.
샤딩은 데이터베이스 규모 확장을 실현하는 훌륭한 기술이나, 완벽하지 않음
시스템이 복잡해지고, 해결해야하는 새로운 문제 발생

## 데이터의 재 샤딩

데이터가 너무 많아져서 하나의 샤드로는 더 이상 감당하기 어려울 때,
샤드간 데이터 분포가 균등하지 않아, 특정 샤드의 공간이 먼저 소진 될 때(샤드 소진)
샤드 소진이 발생하면 샤드 키를 계산하는 함수를 변경, 데이터 재배치 필요.

### 유명인사 문제
특정 샤드에만 질의가 집중되어 서버에 과부하가 걸리는 문제(ex:sns)
특정 샤드에 자주 찾는 유명인이 집중되면 잦은 read연산으로 과부하 발생.
데이터를 쪼개어 각각 특정 유명인사에 샤드를 할당 혹은 더 쪼개야 할 수 있음.

### 조인과 비정규화(join and de-normalization)
샤드끼리는 데이터를 조인하기 어려움.
이를 해결하기 위한 방법중 하나는 데이터베이스를 비정규화하여 하나의 테이블에서 질의를 수행
백만 사용자, 그리고 그 이상

시스템의 규모를 확장하는 것은 지속적이고 반복적(iterative)인 과정.

규모가 커질수록 시스템을 지속적으로 다듬어야함.


## 결론
웹 계층은 무상태 계층으로
모든 계층에 다중화 도입
가능한한 많은 데이터를 캐시할 것.
여러 데이터 센터를 지원할 것.
정적 콘텐츠는 CDN을 통해 서비스
데이터 계층은 샤딩을 통해 그 규모를 확장
각 계층은 독립적 서비스로 분할
시스템을 지속적으로 모니터링, 자동화 도구 활용.