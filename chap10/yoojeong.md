## 10장: 알림 시스템 설계

### 문제 이해 및 설계 범위 확정

```
- 푸시 알림(천만건) / SMS 메시지(백만건) / 이메일(5백만건)
- IOS / Android / 랩톱 / 데스크톱
- soft real-time : 가능한 빨리 전달되어야 하지만 시스템 부하시 약간의 지연은 무방
- 클라이언트 애플리케이션/ 서버 측 스케쥴링
- 알람설정 거부시 알림 받지 않도록 해야함
```

### 개략적인 설계안 제시 및 동의 구하기

#### 알림 유형별 지원 방안

|                                                                                                                              |                                                                                                                                                                                                                                                                                                                                  |
| :--------------------------------------------------------------------------------------------------------------------------: | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|                                                      **iOS 푸시 알림**                                                       | iOS 에서 푸시 알림을 보내기 위해서는 세 가지 컴포넌트가 필요하다.<br>`알림 제공자`: 알림 요청을 만들어 애플 푸시 알림 서비스(APNS: Apple Push Notification Service)로 보내는 주체다.<br>`APNS`: 애플이 제공하는 원격 서비스이며, 푸시 알림을 iOS 장치로 보내는 역할을 한다.<br>`iOS 단말`: 푸시 알림을 수신하는 사용자 단말이다. |
|                                                   **안드로이드 푸시 알림**                                                   | 안드로이드 알림은 iOS 푸시와 비슷한 절차로 전송하며, APNS 대신 FCM(Firebase Cloud Messaging)을 사용하는 점만 다르다.                                                                                                                                                                                                             |
|                                                        **SMS 메시지**                                                        | 트윌리오, 넥스모 등 제 3 사업자의 서비스를 이용하여 보낸다.                                                                                                                                                                                                                                                                      |
|                                                          **이메일**                                                          |
| 회사에서 구축한 메일 서버를 이용해서 전송하거나 aws의 SES(Simple Email Service), 메일침프(Mailchimp) 등을 이용하여 전송한다. |

### 상세 설계

#### 데이터 손실 방지

어떤 상황에서도 알림이 소실되면 안 된다 (알림이 지연되거나 순서가 보장되지는 않아도 됨)

- 알림 데이터를 DB에 보관하고, 재시도 메커니즘 구현
- 알림 로그 DB를 유지

#### 알림 중복 전송 방지

**중복 전송을 100% 방지하는 것은 불가능**하지만, 적어도 중복 전송되는 빈도는 줄일 수 있다.

1. 보내야 할 알림이 도착하면, 그 이벤트 ID를 검사하여 이전에 본적이 있는 이벤트인지 살핀다.
2. 본적이 있는 이벤트면 버리고, 아니면 알림을 발송한다.

#### 알림 템플릿

사전에 지정한 형식에 맞춰 알림을 만들어 내는 틀
템플릿을 사용하면 알림의 형식을 일관성있게 유지하고, 오류 가능성, 알림에 드는 시간을 줄일 수 있다.

#### 알림 설정

사용자가 알림을 받을지 말지에 대한 설정을 상세히 조정할 수 있어야 한다.

#### 전송률 제한

사용자에게 너무 많은 알림을 보내지 않도록 알림의 빈도를 제한한다.

#### 재시도 방법

제3자 서비스가 알림 전송에 실패하면 해당 알림을 재시도 전용 큐에 넣는다. (만약 같은 문제가 계속 발생하면 개발자에게 통지해야함)

#### 푸시 알림과 보안

iOS와 안드로이드 앱의 경우, 알림 전송 API는 시크릿키를 사용하여 보안을 유지한다.
인증된 클라이언트만 해당 API를 사용하여 알림을 보낼 수 있다.

#### 큐 모니터링

큐에서 메시지가 잘 빠져나가는지, 그렇지 못하고 있는지 모니터링하고 대응할 수 있어야 한다.

#### 이벤트 추적

알림 확인율, 클릭율, 실제 앱 사용으로 이루어지는 비율과 같은 메트릭을 만들기 위해 이벤트를 추적하고 분석 서비스와도 통합할 수 있어야 한다.

### 마무리

- `안정성` : 메시지 전송 실패율을 낮추기 위해 안정적인 **재시도 메커니즘**을 도입했다.
- `보안` : 인증된 클라이언트만 알림을 보낼 수 있도록, **시크릿 키 매커니즘**을 이용하였다.
- `이벤트 추적 및 모니터링` : 알림 전송의 각 단계마다 이벤트를 추적하고 **모니터링**할 수 있는 시스템을 통합하였다.
- `사용자 설정` : 사용자가 **알림 수신 설정을 조정**할 수 있도록 하였다.
- `전송률 제한` : 사용자에게 **알림을 보내는 빈도를 제한**할 수 있도록 하였다.
