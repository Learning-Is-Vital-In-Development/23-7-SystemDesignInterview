## 11장: 뉴스 피드 시스템 설계

### 문제 이해 및 설계 범위 확정

```
- 웹, 모바일 모두 지원
- 뉴스피드 발행 / 구독 (시간순 DESC)
- 1인당 최대 구독자는 5천명
- 피드에 텍스트, 이미지, 동영상 업로드 가능
- DAU 1천만명
```

### 개략적인 설계안 제시 및 동의 구하기

**API**

|      API      |     endpoint     |              request              | response  |
| :-----------: | :--------------: | :-------------------------------: | :-------: |
| 피드 발행 API | POST /v1/me/feed | 포스팅 내용<br>authorization 헤더 |           |
| 피드 읽기 API | GET /v1/me/feed  |        Authorization 헤더         | 피드 내용 |

**피드 발행**

**피드 생성**

### 상세 설계

#### 피드 발행 흐름 상세 설계

**웹 서버**
클라이언트와 통신 + 인증 + 처리율 제한

**포스팅 전송(팬아웃) 서비스**

|      |                                                                                                                                                                                                                                                           |                                                                                                                                                                                                                                      |
| :--: | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 모델 | 쓰기 시점에 팬아웃(fanout-on-write) 모델 (push 모델)                                                                                                                                                                                                      | 읽기 시점에 팬아웃(fanout-on-read) 모델(pull 모델)                                                                                                                                                                                   |
| 설명 | 새로운 포스팅을 기록하는 시점에 뉴스 피드를 갱신하게 된다. 포스팅이 완료되면 바로 해당 사용자의 캐시에 해당 포스팅을 기록한다                                                                                                                             | 피드를 읽어야 하는 시점에 뉴스 피드를 갱신한다. 따라서 요청 기반(on-demand)모델이다. 사용자가 본인 홈페이지나 타임라인을 로딩하는 시점에 새로운 포스트를 가져오게 된다.                                                              | 피드를 읽어야 하는 시점에 뉴스 피드를 갱신한다. 따라서 요청 기반(on-demand)모델이다. 사용자가 본인 홈페이지나 타임라인을 로딩하는 시점에 새로운 포스트를 가져오게 된다. |
| 장점 | 뉴스 피드가 실시간으로 갱신되며 친구 목록에 있는 사용자에게 즉시 전송 된다. - 새 포스팅이 기록되는 순간에 뉴스 피드가 이미 갱신되므로(pre-computed) 뉴스 피드를 읽는 데 드는 시간이 짧아진다.                                                             | - 비활성화된 사용자, 또는 서비스에 거의 로그인하지 않는 사용자의 경우에는 이 모델이 유리하다. 로그인하기까지는 어떤 컴퓨팅 자원도 소모하지 않아서다. - 데이터를 친구 각각에 푸시하는 작입이 필요 없으므로 핫키 문제도 생기지 않는다. |
| 단점 | 사용자가 많은 사용자의 경우 친구 목록을 가져오고 그 목록에 있는 사용자 모두의 뉴스 피드를 갱신하는 데 많은 시간이 소요될 수도 있다. 핫키(hotkey)라고 부르는 문제다 - 서비스를 자주 이용하지 않는 사용자의 피드까지 갱신해야 하므로 컴퓨팅자원이 낭비된다. | - 뉴스 피드를 읽는 데 많은 시간이 소요될 수 있다.                                                                                                                                                                                    |

**피드 읽기 흐름 상세 설계**

**캐시 구조**

- 뉴스피드 : 뉴스피드 ID
- 콘텐츠 : 포스팅 데이터. 인기 콘텐츠는 따로 보관
- 소셜 그래프 : 사용자 간 관계 정보 보관
- 행동 : 좋아요, 답글 등
- 횟수 : 좋아요 횟수, 응답 수, 팔로어 수, 팔로잉 수 등
