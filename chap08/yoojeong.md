## 8장: URL 단축기 설계

### 문제 이해 및 설계 범위 확정

```
- 0-9, a-z(26), A-Z(26) 총 62개 문자만 허용
- POST 기준 1160 TPS (DAU 1억건/86400초)
- GET 연산을 POST 의 10배로 가정시 11600 TPS
- 하루 1억건씩 10년이면 총 3650건의 레코드 보관
- 1레코드 당 100byte 가정시 36.5TB 필요
```

### 개략적인 설계안 제시 및 동의 구하기

#### API 엔드포인트

클라이언트는 서버가 제공하는 API 엔드포인트를 통해 서버와 통신하며, API 엔드포인트는 REST 스타일로 설계되어야한다.

|     desc     |       API Endpoint        |  request   |  response   |
| :----------: | :-----------------------: | :--------: | :---------: |
|   URL 단축   | POST /api/v1/data/shorten | origin url | shorten url |
| URL 리디렉션 |   GET /api/v1/shortUrl    |     -      | origin url  |

#### URL 리디렉션

- `301 Permanently Moved`
  - 응답의 Location 헤더에 리디렉션 할 URL 제공
  - 브라우저는 이 응답을 캐시하여 재요청시 브라우저 캐시 사용
- `302 Found`
  - 응답의 Location 헤더에 리디렉션 할 URL 제공
  - 브라우저는 이 응답을 캐시하지 않아 재요청 발생
  - 트래픽 분석이 중요할때의 선택지

#### URL 단축

- 주어진 URL이 다르면 해시 값도 달라야 한다
- 계산된 해시 값은 원래 입력으로 주어졌던 긴 URL로 복원될 수 있어야 한다

### 상세 설계

#### 데이터 모델

```json
{
  "id": "",
  "shortURL": "",
  "longURL": ""
}
```

#### 해시 함수

원래 URL을 단축 URL로 변환하는데 사용

**해시 값 길이**

- HasValue는 [0-9, a-z, A-Z]의 문자 (62개)
- HashValue의 길이는 7
  - 62^7(=~3.5조)로 3,650억 개의 URL 커버 가능

**해시 함수 구현**

1. 해시 후 충돌 해소
   - CRC32, MD5, SHA-1 등 well-known 해시로 값을 구한 후 처음 7개 글자만 사용
   - 기존 존재하는 HashValue가 있을 경우 지정 문자열 추가
   - 1회 이상 DB에 Query 하므로 오버헤드가 큼
2. Base-62 변환
   - 유일 ID 생성기를 이용해 ID를 생성한후 62진법으로 변환하는 알고리즘
   - 단축 URL의 길이가 가변적이다

**접근법 비교**

| 해시 후 충돌 해소 전략                                                                    | Base-62 변환                                                                                                                 |
| ----------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------- |
| ￼단축 URL의 길이가 고정됨                                                                 | 단축 URL의 길이가 가변적. ID 값이 커지면 같이 길어짐                                                                         |
| 유일성이 보장되는 ID 생성이라 필요 없음                                                   | 유일성 보장 ID 생성기 필요                                                                                                   |
| 충돌이 가능해서 해소 전략 필요                                                            | ID 유일성이 보장된 후에야 적용 가능한 전략이라 충족은 아예 불가능                                                            |
| ID초부터 단축 URL을계산하는 방식이 아니라서 다음에 쓸수록 있는 URL을 알아내는 것이 불가능 | ID가 1씩 증가하는 값이라고 가정하면 다음에 쓸 수 있는 단축 URL이 무엇인지 쉽게 알아낼 수 있어서 보안성 문제가 될 소지가 있음 |

### 마무리

![image](https://github.com/rachel5004/23-7-SystemDesignInterview/assets/75432228/ed90c644-f512-4ae4-bfb6-b7b95867d4e0)

