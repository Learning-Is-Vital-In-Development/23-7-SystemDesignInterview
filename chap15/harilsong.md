# 15장. 구글드라이브 설계

## 문제 이해 및 설계 범위 확정

- 업로드/다운로드, 동기화, 알림
- 모바일 앱, 웹 앱 지원
- 파일 암호화
- 10GB 의 파일크기 제한
- MAU 10M

다음 기능의 설계에 집중한다.

- 파일 추가, 가장 쉬운 방법은 파일을 구글 드라이브 안으로 drag-and-drop 하는 것
- 파일 다운로드
- 파일 동기화
- 파일 갱신 이력 조회
- 파일 공유
- 파일이 편집되거나 삭제되거나 새롭게 공유되었을 때 알림 표시

기능적 요구사항 이외에, 다음의 비 기능적 요구사항을 이해하는 것도 중요하다.

- 안정성
- 빠른 동기화 속도
- 네트워크 대역폭
- 규모 확장성
- 높은 가용성

### 개략적 추정치

- 가입 사용자는 50M 명이고 천만 명의 DAU 사용자가 있다고 가정
- 모든 사용자에게 10GB 의 무료 저장공간 할당
- 매일 각 사용자가 평균 2개의 파일을 업로드한다고 가정. 각파일의 평균 크기는 500KB
- 읽기 쓰기 비율은 1:1
- 필요한 저장공간 총량 = 50M * 10GB = 500PB
- 업로드 API QPS = 1천만 사용자 * 2회 업로드/24시간/3600초 = 약 240
- 최대 QPS = QPS * 2 = 480

## 개략적 설계안 제시 및 동의 구하기

### API

- 파일 업로드 API
  - 단순 업로드
  - 이어 올리기
- 파일 다운로드 API
- 파일 갱신 히스토리 API

### 한 대 서버의 제약 극복

샤딩과 S3 를 사용한 데이터 다중화를 통해 데이터 손실 가능성을 최소화한다. 다음 부분에 대해 더 고민해볼 수 있다.

- 로드밸런서
- 웹 서버
- 메타데이터 데이터베이스
- 파일 저장소

### 동기화 충돌

동시에 같은 파일이나 업데이트하는 경우, 발생하는 문제를 해소해야 합니다.

- 사용자 단말: 사용자가 이용하는 웹브라우저나 모바일 앱 등의 클라이언트
- 블록 저장소 서버(block server): 파일 블록을 클라우드 저장소에 업로드하는 서버
- 클라우드 저장소
- 아카이빙 저장소: 비활성 데이터
- 로드밸런서
- API 서버
- 메타데이터 데이터베이스
- 알림 서비스
- 오프라인 사용자 백업 큐

## 상세 설계

### 블록 저장소 서버

- 델타 동기화 : 파일이 수정되면 수정된 부분만 동기화
- 압축 : 블록 단위로 압축해 두면 데이터크기를 많이 줄일 수 있다.

### 높은 일관성 요구사항

- 강한 일관성 모델을 지원해줘야 한다. ACID 를 기본적으로 지원하는 RDB 가 유리할 것이다.

### 메타데이터 데이터베이스

### 업로드 절차

### 다운로드 절차

### 알림 서비스

- 롱 폴링
- 웹소켓

채팅 서비스와는 달리 클라우드 드라이브 시스템의 경우에는 알림 서비스와 양방향 통신이 필요하지 않기 때문에 롱 폴링이 좀 더 적절하다.

### 저장소 공간 절약

- 중복 제거 : 해시 값을 비교하여 두 블록이 같은 블록인지 판단한 후 중복된 블록을 제거한다.
- 지능적 백업 전략 도입
  - 한도 설정
  - 중요한 버전만 보관
- 아카이빙 저장소 활용

### 장애 처리

- 로드밸런서 장애
- 블록 저장소 서버 장액
- 클라우드 저장소 장애
- API 서버 장애
- 메타데이터 캐시 장애
- 메타데이터 데이터베이스 장애
- 알림 서비스 장애
- 오프라인 사용자 백업 큐 장애

## 마무리

설계에는 답이 없습니다.

- 블록 저장소 서버가 없는 경우
- 접속상태를 관리하는 로직을 새로 분리
