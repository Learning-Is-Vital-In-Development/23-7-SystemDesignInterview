
## 15장. 구글 드라이브 설계

### 문제 이해 및 설계 범위 확정

**요구사항**

```
- 파일 추가, 가장 쉬운 방법은 drag&drop
- 파일 다운로드
- 여러 단말에 파일 동기화, 한 단말에서 파일을 추가하면 다른 단말에도 자동으로 동기화
- 파일 갱신 이력 조회
- 파일 공유
- 파일이 편집되거나 삭제되거나 새롭게 공유되었을 때 알림 표시
- 구글 문서 편집 및 협업 기능은 요구사항에서 제외
```

**개략적 규모 추정**

- 가입 사용자는 5000만명이고 1000만명의 DAU
- 모든 사용자에게 10GB의 무료 저장공간 할당
- 매일 각 사용자가 평균 2개의 파일을 업로드, 각 파일의 평균 크기는 500KB
- 읽기:쓰기 비율을 1:1
- 필요한 저장공간 총량 = 5000만 사용자 X 10GB = 500 petabyte
- 업로드 API QPS = 약 240 (1000만 사용자 X 2회 업로드 / 24시간 / 3600초)
- 최대 QPS = QPS X 2 = 480

### 개략적 설계안 제시 및 동의 구하기

![image](https://github.com/rachel5004/23-7-SystemDesignInterview/assets/75432228/bb06023c-5fd6-423f-a71f-2505aecc55b6)

- 블록 저장소 서버: 파일 블록을 클라우드 저장소에 업로드하는 서버
    - 파일을 여러 개의 블록으로 나눠서 저장
    - 각 블록에 고유한 해시 할당 ⇒ 메타데이터 데이터베이스 저장
    - 하나의 블록은 최대 4MB
- 클라우드 저장소: 블록 단위로 나뉘어진 파일 보관
- 아카이빙 저장소: 오랫동안 사용되지 않은 비황성 데이터를 저장하기 위한 시스템
- 메타데이터 데이터베이스: 사용자, 파일, 블록, 버전 메타데이터 정보 관리
- 메타데이터 캐시: 자주 쓰이는 메타 데이터 캐시
- 알림 서비스: pub-sub 시스템
- 오프라인 사용자 백업 큐: 클라이언트가 접속 중이 아닐 때 파일의 최신 상태를 큐에 두어 접속했을 때 동기화될 수 있도록 함


### 상세 설계

**블록 저장소 서버**

![image](https://github.com/rachel5004/23-7-SystemDesignInterview/assets/75432228/531f65b7-1f95-4129-80a7-eb10aff0dfd0)

- 네트워크 대역폭 최적화
    - delta sync : 전체 파일을 수정하는 대신 수정이 일어난 블록만 동기화
    - compression : 블록 단위 압축
- 클라이언트가 보낸 파일을 블록단위로 분할 -> 압축 -> 암호화 -> 블록들 중 수정된 부분만 추출하여 업로드


**높은 일관성 요구사항**

- 캐시에 보관된 사본과 데이터베이스에 있는 원본의 일치
- 데이터베이스에 보관된 원본에 변경이 발생하면 캐시에 있는 사본 무효화
- ACID를 보장하는 관계형 데이터베이스는 강한 일관성 보장이 쉬움
- NoSQL 데이터베이스는 이를 기본으로 지원하지 않으므로 동기화 로직 필요


**메타데이터 DB**

![image](https://github.com/rachel5004/23-7-SystemDesignInterview/assets/75432228/b18f1685-a72b-4d6f-a353-9ae37a151a7f)


**업로드 절차**

![image](https://github.com/rachel5004/23-7-SystemDesignInterview/assets/75432228/bb1497b8-b82c-4802-9bf5-b99d20458f94)

**다운로드 절차**

![image](https://github.com/rachel5004/23-7-SystemDesignInterview/assets/75432228/5f2e90b9-cca8-458a-b48f-aa8916a0940e)

**알림 서비스**

- 롱 폴링 : 오랜 시간 연결을 유지하다가 특정 파일에 대한 변경을 감지하면 연결 끊고 최신 내역 다운로드 후 연결 복원
- 웹 소켓 : 실시간 양방향 통신

> 이벤트가 낫지않나?

**저장소 공간 절약**

- 중복 제거
    - 블록 해시 비교
- 지능적 백업 전략
    - 한도 설정: 보관해야 하는 파일 버전 개수 상한
    - 중요한 버전만 보관
- 자주 쓰이지 않은 데이터는 아카이빙 저장소로 이관

**장애 처리**

- 로드밸런서 장애 ⇒ 부 로드밸런서 활성화
- 블록 저장소 서버 장애 ⇒ 다른 서버가 미원효 또는 대기 상태인 작업 이어 받기
- 클라우드 저장소 장애 ⇒ 다중화
- API 서버 장애 ⇒ 무상태 서버
- 메다데이터 캐시 장애 ⇒ 다중화
- 메타데이터 데이터베이스 장애
    - 주 데이터베이스 서버 장애 ⇒ 부 서버 중 하나를 주 서버로 변경, 부 서버 추가
    - 부 데이터베이스 서버 장애 ⇒ 장애 서버 교체
- 알림 서비스 장애 ⇒ 롱 폴링 재설정 (오래 걸림)
- 오프라인 사용자 백업 큐 장애 ⇒ 다중화, 구독 중인 클라이언트들은 백업 큐로 재설정
